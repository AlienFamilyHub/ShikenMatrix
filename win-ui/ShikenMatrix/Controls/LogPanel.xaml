<?xml version="1.0" encoding="utf-8"?>
<UserControl
    x:Class="ShikenMatrix.Controls.LogPanel"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:ShikenMatrix.Models"
    xmlns:converters="using:ShikenMatrix.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <UserControl.Resources>
        <converters:LogLevelColorConverter x:Key="LogLevelColorConverter"/>
        <converters:LogLevelIconConverter x:Key="LogLevelIconConverter"/>
        <converters:TimestampFormatConverter x:Key="TimestampFormatConverter"/>

        <DataTemplate x:Key="LogEntryTemplate" x:DataType="models:LogEntry">
            <Border Margin="0,0,0,6"
                    CornerRadius="6"
                    BorderThickness="1"
                    BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}"
                    Background="{ThemeResource LayerFillColorDefaultBrush}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="4"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="30"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- 左侧状态颜色条 -->
                    <Rectangle Grid.Column="0"
                               Fill="{Binding Level, Converter={StaticResource LogLevelColorConverter}}"
                               RadiusX="2"
                               RadiusY="2"
                               Margin="0,2,0,2"/>

                    <!-- 时间戳 -->
                    <TextBlock Grid.Column="1"
                               Text="{Binding Timestamp, Converter={StaticResource TimestampFormatConverter}}"
                               FontFamily="Consolas"
                               FontSize="12"
                               Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                               VerticalAlignment="Center"
                               Margin="10,8,4,8"/>

                    <!-- 等级图标 -->
                    <FontIcon Grid.Column="2"
                              Glyph="{Binding Level, Converter={StaticResource LogLevelIconConverter}}"
                              FontSize="12"
                              Foreground="{Binding Level, Converter={StaticResource LogLevelColorConverter}}"
                              HorizontalAlignment="Center"
                              VerticalAlignment="Center"/>

                    <!-- 消息文本 -->
                    <TextBlock Grid.Column="3"
                               Text="{Binding Message}"
                               FontFamily="Segoe UI"
                               FontSize="13"
                               TextWrapping="Wrap"
                               Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                               IsTextSelectionEnabled="True"
                               VerticalAlignment="Center"
                               Margin="0,8,8,8"/>
                </Grid>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 日志工具栏 -->
        <Grid Grid.Row="0"
              Padding="16,12"
              Background="{ThemeResource LayerFillColorDefaultBrush}"
              BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
              BorderThickness="0,0,0,1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Orientation="Horizontal"
                        Spacing="8"
                        VerticalAlignment="Center">
                <FontIcon Glyph="&#xE756;"
                          FontSize="14"
                          Foreground="{ThemeResource AccentFillColorDefaultBrush}"/>
                <TextBlock Text="终端控制台 (Terminal)"
                           FontSize="13"
                           FontWeight="SemiBold"
                           Foreground="{ThemeResource TextFillColorPrimaryBrush}"/>
            </StackPanel>

            <StackPanel Grid.Column="2"
                        Orientation="Horizontal"
                        Spacing="8">
                <AutoSuggestBox Width="240"
                                PlaceholderText="搜索日志 / Search Logs..."
                                Text="{Binding SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                QueryIcon="Find"/>

                <ToggleButton IsChecked="{Binding AutoScroll, Mode=TwoWay}"
                              ToolTipService.ToolTip="自动滚动">
                    <FontIcon Glyph="&#xE74B;" FontSize="14"/>
                </ToggleButton>

                <Button Click="OnClearLogsClick"
                        ToolTipService.ToolTip="清空日志">
                    <FontIcon Glyph="&#xE74D;" FontSize="14"/>
                </Button>
            </StackPanel>
        </Grid>

        <!-- 日志列表 -->
        <ListView Grid.Row="1"
                  ItemsSource="{Binding FilteredLogs}"
                  ItemTemplate="{StaticResource LogEntryTemplate}"
                  SelectionMode="Single"
                  Padding="12"
                  Background="Transparent">
            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="Padding" Value="0"/>
                    <Setter Property="Margin" Value="0"/>
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                </Style>
            </ListView.ItemContainerStyle>
            <ListView.ItemsPanel>
                <ItemsPanelTemplate>
                    <ItemsStackPanel ItemsUpdatingScrollMode="KeepLastItemInView"/>
                </ItemsPanelTemplate>
            </ListView.ItemsPanel>
        </ListView>
    </Grid>
</UserControl>
