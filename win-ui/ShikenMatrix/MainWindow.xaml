<?xml version="1.0" encoding="utf-8"?>
<Window
    x:Class="ShikenMatrix.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:ShikenMatrix"
    xmlns:models="using:ShikenMatrix.Models"
    xmlns:converters="using:ShikenMatrix.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Title="ShikenMatrix">

    <!-- 启用云母材质 (Mica Alt)，为了让它生效，根 Grid 必须透明 -->
    <Window.SystemBackdrop>
        <MicaBackdrop Kind="BaseAlt"/>
    </Window.SystemBackdrop>

    <!-- 根容器背景透明，透出 Mica 效果 -->
    <Grid Background="Transparent">
        <Grid.Resources>
            <!-- Converters -->
            <converters:LogLevelColorConverter x:Key="LogLevelColorConverter"/>
            <converters:LogLevelIconConverter x:Key="LogLevelIconConverter"/>
            <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
            <converters:ColorNameToBrushConverter x:Key="ColorNameToBrushConverter"/>
            <converters:TimestampFormatConverter x:Key="TimestampFormatConverter"/>
            <converters:BoolInvertConverter x:Key="BoolInvertConverter"/>
            <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
            <converters:StringNotEmptyConverter x:Key="StringNotEmptyConverter"/>

            <!-- 样式：卡片容器 -->
            <Style x:Key="SidebarCardStyle"
                    TargetType="Border">
                <Setter Property="Background"
                        Value="{ThemeResource LayerFillColorDefaultBrush}"/>
                <Setter Property="BorderBrush"
                        Value="{ThemeResource SurfaceStrokeColorDefaultBrush}"/>
                <Setter Property="BorderThickness"
                        Value="1"/>
                <Setter Property="CornerRadius"
                        Value="8"/>
                <Setter Property="Padding"
                        Value="12"/>
                <Setter Property="Margin"
                        Value="0,0,0,12"/>
                <Setter Property="Shadow">
                    <Setter.Value>
                        <ThemeShadow/>
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- 样式：日志条目 -->
            <DataTemplate x:Key="LogEntryTemplate"
                    x:DataType="models:LogEntry">
                <Border Margin="0,0,0,6"
                        CornerRadius="6"
                        BorderThickness="1"
                        BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}"
                        Background="{ThemeResource LayerFillColorDefaultBrush}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="4"/>
                            <!-- 色彩指示条 -->
                            <ColumnDefinition Width="Auto"/>
                            <!-- 时间 -->
                            <ColumnDefinition Width="30"/>
                            <!-- 图标 -->
                            <ColumnDefinition Width="*"/>
                            <!-- 消息 -->
                        </Grid.ColumnDefinitions>

                        <!-- 左侧状态颜色条 -->
                        <Rectangle Grid.Column="0"
                                   Fill="{Binding Level, Converter={StaticResource LogLevelColorConverter}}"
                                   RadiusX="2"
                                RadiusY="2"
                                   Margin="0,2,0,2"/>

                        <!-- 时间戳 -->
                        <TextBlock Grid.Column="1"
                                   Text="{Binding Timestamp, Converter={StaticResource TimestampFormatConverter}}"
                                   FontFamily="Consolas"
                                   FontSize="12"
                                   Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                   VerticalAlignment="Center"
                                   Margin="10,8,4,8"/>

                        <!-- 等级图标 -->
                        <FontIcon Grid.Column="2"
                                  Glyph="{Binding Level, Converter={StaticResource LogLevelIconConverter}}"
                                  FontSize="12"
                                  Foreground="{Binding Level, Converter={StaticResource LogLevelColorConverter}}"
                                  HorizontalAlignment="Center"
                                  VerticalAlignment="Center"/>

                        <!-- 消息文本 -->
                        <TextBlock Grid.Column="3"
                                   Text="{Binding Message}"
                                   FontFamily="Segoe UI"
                                   FontSize="13"
                                   TextWrapping="Wrap"
                                   Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                                   IsTextSelectionEnabled="True"
                                   VerticalAlignment="Center"
                                   Margin="0,8,8,8"/>
                    </Grid>
                </Border>
            </DataTemplate>
        </Grid.Resources>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="280"
                    MinWidth="260"
                    MaxWidth="350"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- MARK: 左侧面板 - 控制区 -->
        <!-- 使用 Acrylic 风格的半透明背景叠加 -->
        <Grid Grid.Column="0"
              Background="{ThemeResource LayerFillColorAltBrush}"
              BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
              BorderThickness="0,0,1,0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <!-- 顶部控制 -->
                <RowDefinition Height="*"/>
                <!-- 滚动内容 -->
                <RowDefinition Height="Auto"/>
                <!-- 底部版权 -->
            </Grid.RowDefinitions>

            <!-- 1. 顶部控制栏 (取代了原标题栏) -->
            <Grid Grid.Row="0"
                    Padding="20,24,20,16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- 连接状态 -->
                <StackPanel Grid.Column="0"
                        Orientation="Vertical"
                        VerticalAlignment="Center"
                        Spacing="2">
                    <TextBlock Text="系统状态"
                            FontSize="10"
                            Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                            FontWeight="Bold"/>
                    <StackPanel Orientation="Horizontal"
                            Spacing="6">
                        <Ellipse Width="8"
                                Height="8"
                                VerticalAlignment="Center"
                                 Fill="{Binding StatusIndicatorColor, Converter={StaticResource ColorNameToBrushConverter}}"/>
                        <TextBlock Text="{Binding StatusMessage}"
                                   FontSize="13"
                                   FontWeight="SemiBold"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    </StackPanel>
                </StackPanel>

                <!-- 总开关 -->
                <ToggleSwitch Grid.Column="1"
                              IsOn="{x:Bind ViewModel.IsRunning, Mode=OneWay}"
                              OffContent=""
                        OnContent=""
                              MinWidth="0"
                              Toggled="OnToggleSwitchToggled"
                              IsEnabled="{Binding Config.WsUrl, Converter={StaticResource StringNotEmptyConverter}}"
                              ToolTipService.ToolTip="连接开关"/>
            </Grid>

            <MenuFlyoutSeparator Grid.Row="0"
                    VerticalAlignment="Bottom"
                    Margin="20,0,20,0"/>

            <!-- 2. 内容区 -->
            <ScrollViewer Grid.Row="1"
                    Padding="20">
                <StackPanel Spacing="6">

                    <!-- 监控卡片标题 -->
                    <StackPanel Orientation="Horizontal"
                            Spacing="6"
                            Margin="0,4,0,8">
                        <FontIcon Glyph="&#xE9D9;"
                                FontSize="12"
                                Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                        <TextBlock Text="LIVE MONITOR"
                                   Style="{StaticResource CaptionTextBlockStyle}"
                                   Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                   FontWeight="Bold"
                                   Opacity="0.8"/>
                    </StackPanel>

                    <!-- 等待状态 (空) -->
                    <Border Style="{StaticResource SidebarCardStyle}"
                            Visibility="{Binding CurrentWindow, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter=Inverse}">
                        <StackPanel Spacing="12"
                                HorizontalAlignment="Center"
                                Padding="24">
                            <ProgressRing IsActive="{Binding IsRunning}"
                                    Width="24"
                                    Height="24"
                                    Foreground="{ThemeResource AccentFillColorDefaultBrush}"/>
                            <TextBlock Text="等待信号接入..."
                                       FontSize="12"
                                       Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                        </StackPanel>
                    </Border>

                    <!-- 活跃窗口卡片 -->
                    <Border Style="{StaticResource SidebarCardStyle}"
                            Visibility="{Binding CurrentWindow, Converter={StaticResource NullToVisibilityConverter}}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- 窗口图标 -->
                            <Grid Grid.Column="0"
                                    Width="40"
                                    Height="40"
                                    Margin="0,0,12,0">
                                <Ellipse Fill="{ThemeResource SolidBackgroundFillColorBaseBrush}"
                                        Stroke="{ThemeResource DividerStrokeColorDefaultBrush}"
                                        StrokeThickness="1"/>
                                <FontIcon Glyph="&#xE792;"
                                        FontSize="18"
                                        Foreground="{ThemeResource AccentFillColorDefaultBrush}"/>
                            </Grid>

                            <StackPanel Grid.Column="1"
                                    Spacing="2"
                                    VerticalAlignment="Center">
                                <TextBlock Text="当前活动窗口"
                                        FontSize="10"
                                        Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                                <TextBlock Text="{Binding CurrentWindow.Title}"
                                           FontSize="13"
                                        FontWeight="SemiBold"
                                           TextTrimming="CharacterEllipsis"
                                        MaxLines="1"/>
                                <TextBlock Text="{Binding CurrentWindow.ProcessName}"
                                           FontSize="11"
                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- 媒体卡片 -->
                    <Border Style="{StaticResource SidebarCardStyle}"
                            Visibility="{Binding CurrentMedia, Converter={StaticResource NullToVisibilityConverter}}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- 封面占位 -->
                            <Border Grid.Column="0"
                                    Width="40"
                                    Height="40"
                                    CornerRadius="6"
                                    Background="{ThemeResource SurfaceStrokeColorDefaultBrush}"
                                    Margin="0,0,12,0">
                                <FontIcon Glyph="&#xE8D6;"
                                        FontSize="16"
                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                          HorizontalAlignment="Center"
                                        VerticalAlignment="Center"/>
                            </Border>

                            <StackPanel Grid.Column="1"
                                    Spacing="0"
                                    VerticalAlignment="Center">
                                <TextBlock Text="正在播放"
                                        FontSize="10"
                                        Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                                <TextBlock Text="{Binding CurrentMedia.Title}"
                                           FontSize="13"
                                        FontWeight="SemiBold"
                                           TextTrimming="CharacterEllipsis"/>
                                <TextBlock Text="{Binding CurrentMedia.Artist}"
                                           FontSize="11"
                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                           TextTrimming="CharacterEllipsis"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- 错误提示 -->
                    <InfoBar IsOpen="{Binding HasError}"
                             Severity="Error"
                             Title="错误"
                             Message="{Binding LastError}"
                             IsClosable="False"
                             Margin="0,0,0,12"/>

                    <Rectangle Height="1"
                            Fill="{ThemeResource DividerStrokeColorDefaultBrush}"
                            Margin="0,12,0,16"/>

                    <!-- 设置区域 -->
                    <StackPanel Spacing="16">
                        <StackPanel Orientation="Horizontal"
                                Spacing="6">
                            <FontIcon Glyph="&#xE713;"
                                    FontSize="12"
                                    Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                            <TextBlock Text="CONFIGURATION"
                                    Style="{StaticResource CaptionTextBlockStyle}"
                                       Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                    FontWeight="Bold"
                                    Opacity="0.8"/>
                        </StackPanel>

                        <StackPanel Spacing="12">
                            <TextBox Header="服务器地址 (Host)"
                                     Text="{Binding Config.WsUrl, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     PlaceholderText="ws://localhost:port"
                                     FontSize="12"
                                     IsEnabled="{Binding IsRunning, Converter={StaticResource BoolInvertConverter}}"/>

                            <PasswordBox Header="认证令牌 (Token)"
                                         Password="{Binding Config.Token, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                         PlaceholderText="Access Token"
                                         PasswordChar="•"
                                         FontSize="12"
                                         IsEnabled="{Binding IsRunning, Converter={StaticResource BoolInvertConverter}}"/>

                            <ToggleSwitch Header="上报媒体状态"
                                          IsOn="{Binding Config.EnableMediaReporting, Mode=TwoWay}"
                                          IsEnabled="{Binding IsRunning, Converter={StaticResource BoolInvertConverter}}"
                                          FontSize="12"/>
                        </StackPanel>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>

            <!-- 3. 底部信息 -->
            <StackPanel Grid.Row="2"
                    Background="{ThemeResource LayerFillColorDefaultBrush}"
                    Padding="16,12"
                        BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                    BorderThickness="0,1,0,0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel>
                        <TextBlock Text="SHIKEN MATRIX"
                                FontSize="10"
                                FontWeight="Bold"
                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                        <TextBlock Text="v0.1.0 • Stable"
                                FontSize="9"
                                Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                    </StackPanel>

                    <!-- GitHub 链接 -->
                    <Border Grid.Column="1"
                            x:Name="GitHubBorder"
                            Background="{ThemeResource SubtleFillColorTransparentBrush}"
                            CornerRadius="4"
                            Padding="6,2"
                            BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                            BorderThickness="1"
                            PointerEntered="OnGitHubHoverEntered"
                            PointerExited="OnGitHubHoverExited">
                        <FlyoutBase.AttachedFlyout>
                            <Flyout x:Name="GitHubFlyout"
                                    Placement="Bottom">
                                <StackPanel Spacing="8"
                                           Width="280">
                                    <TextBlock Text="ShikenMatrix"
                                              FontSize="14"
                                              FontWeight="SemiBold"
                                              Foreground="{ThemeResource TextFillColorPrimaryBrush}"/>
                                    
                                    <TextBlock Text="https://github.com/AlienFamilyHub/ShikenMatrix"
                                              FontSize="11"
                                              FontFamily="Consolas"
                                              Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                              TextWrapping="Wrap"
                                              IsTextSelectionEnabled="True"/>
                                    
                                    <Button Content="在浏览器中打开"
                                           HorizontalAlignment="Stretch"
                                           Click="OnGitHubButtonClick"/>
                                </StackPanel>
                            </Flyout>
                        </FlyoutBase.AttachedFlyout>
                        <StackPanel Orientation="Horizontal"
                                    Spacing="4">
                            <FontIcon Glyph="&#xE774;"
                                      FontSize="10"
                                      Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                            <TextBlock Text="GitHub"
                                       FontSize="10"
                                       FontWeight="SemiBold"
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                        </StackPanel>
                    </Border>
                </Grid>
            </StackPanel>
        </Grid>

        <!-- MARK: 右侧面板 - 终端日志 -->
        <Grid Grid.Column="1"
                Background="Transparent">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- 日志工具栏 -->
            <!-- 使用半透明背景以适配 Mica -->
            <Grid Grid.Row="0"
                    Padding="16,12"
                    Background="{ThemeResource LayerFillColorDefaultBrush}"
                  BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                    BorderThickness="0,0,0,1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal"
                        Spacing="8"
                        VerticalAlignment="Center">
                    <FontIcon Glyph="&#xE756;"
                            FontSize="14"
                            Foreground="{ThemeResource AccentFillColorDefaultBrush}"/>
                    <TextBlock Text="终端控制台 (Terminal)"
                            FontSize="13"
                            FontWeight="SemiBold"
                            Foreground="{ThemeResource TextFillColorPrimaryBrush}"/>
                </StackPanel>

                <StackPanel Grid.Column="2"
                        Orientation="Horizontal"
                        Spacing="8">
                    <AutoSuggestBox Width="240"
                                    PlaceholderText="搜索日志 / Search Logs..."
                                    Text="{Binding SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                    QueryIcon="Find"/>

                    <ToggleButton IsChecked="{Binding AutoScroll, Mode=TwoWay}"
                            ToolTipService.ToolTip="自动滚动">
                        <FontIcon Glyph="&#xE74B;"
                                FontSize="14"/>
                    </ToggleButton>

                    <Button Click="{x:Bind ViewModel.ClearLogs}"
                            ToolTipService.ToolTip="清空日志">
                        <FontIcon Glyph="&#xE74D;"
                                FontSize="14"/>
                    </Button>
                </StackPanel>
            </Grid>

            <!-- 日志列表 -->
            <!-- 背景设为 Transparent 让下面的 Mica 透出来 -->
            <ListView Grid.Row="1"
                      ItemsSource="{Binding FilteredLogs}"
                      ItemTemplate="{StaticResource LogEntryTemplate}"
                      SelectionMode="Single"
                      Padding="12"
                      Background="Transparent">
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="Padding"
                                Value="0"/>
                        <Setter Property="Margin"
                                Value="0"/>
                        <Setter Property="HorizontalContentAlignment"
                                Value="Stretch"/>
                    </Style>
                </ListView.ItemContainerStyle>
                <ListView.ItemsPanel>
                    <ItemsPanelTemplate>
                        <ItemsStackPanel ItemsUpdatingScrollMode="KeepLastItemInView"/>
                    </ItemsPanelTemplate>
                </ListView.ItemsPanel>
            </ListView>
        </Grid>
    </Grid>
</Window>